{"version":3,"file":"index.min.js","sources":["../src/index.js"],"sourcesContent":["import * as Repository from 'block_novelties_notices/repository';\nimport Ajax from 'core/ajax';\n\nexport const init = () => {\n\n    // eslint-disable-next-line no-undef\n    new Vue({\n        el: '#block_novelties_notices',\n        // eslint-disable-next-line no-undef\n        vuetify: new Vuetify(),\n        data: {\n            loading: true,\n            // Recolecion de data no limpiada\n            novelties: null,\n            alertsConfigs: null,\n            alerts: [],\n            langKeys: [],\n            // Renderizado final,\n            dataToRender: [],\n            // Variables de la aplicacion/bloque\n            tab: null\n        },\n        methods: {\n            async getLangsKey() {\n                var langskeys = null;\n                // Chequeamos si existe dentro de la variable global M\n                // si no existe mandamos a hacer la peticion caso contrario tomamos lo que ya existe\n                if (!M.hasOwnProperty(\"plugins\")) {\n                    var response = await Ajax.call([{\n                        methodname: 'local_alerts_front_get_langs',\n                        args: {}\n                    }])[0];\n                    langskeys = JSON.parse(response.lang);\n                } else {\n                    // eslint-disable-next-line no-console\n                    langskeys = M.plugins.courseView.langsKeys;\n                }\n                this.langKeys = langskeys;\n            },\n            async getNovelties() {\n                let args = {\n                    course_id: M.cfg.courseId == 1 ? null : M.cfg.courseId\n                    // Limit: models.limit\n                };\n\n                let novelties = await Repository.getNovelties(args);\n\n                for (let i = 0; i < novelties.length; i++) {\n                    novelties[i].is_active = i === 0;\n                    novelties[i].is_novelty = true;\n                }\n\n                this.novelties = novelties;\n            },\n            async getAlertsConfigs() {\n                var configskeys = null;\n                // Chequeamos si existe dentro de la variable global M\n                // si no existe mandamos a hacer la peticion caso contrario tomamos lo que ya existe\n                if (!M.hasOwnProperty(\"plugins\")) {\n                    var response = await Ajax.call([{\n                        methodname: 'local_alerts_front_get_configs',\n                        args: {\n                            userid: M.cfg.contextInstanceId\n                        }\n                    }])[0];\n                    configskeys = JSON.parse(response.configs);\n                } else {\n                    if(M.plugins.courseView.configs.configs){\n                        configskeys = JSON.parse(M.plugins.courseView.configs.configs);\n                    }else{\n                        configskeys = M.plugins.courseView.configs;\n                    }\n                }\n                this.alertsConfigs = configskeys;\n            },\n            async getAlerts() {\n                var params = new URLSearchParams();\n                params.set('userid', this.alertsConfigs.user_id);\n                params.set('institution', this.alertsConfigs.institution);\n                params.set('modality', this.alertsConfigs.modality);\n                params.set('courseid', M.cfg.courseId);\n\n                var fetchurl = `${this.alertsConfigs.urlapi}/notices?${params.toString()}`;\n\n                var response = await fetch(`${fetchurl}`).catch(function () {\n                    return undefined;\n                });\n\n                if (response !== undefined && response.status !== 404) {\n                    this.alerts = await response.json();\n                }\n            },\n            orderTopics() {\n                if(this.dataToRender.length > 0){\n                    const orderTopics = [\n                        'forum_news',\n                        'overdue_activities',\n                        'activities_course_soon_close',\n                        'corrected_activities',\n                        'direct_response_forum',\n                        'new_activities',\n                        'direct_message_teacher'\n                    ];\n\n                    const objetoOrdenado = this.dataToRender.sort((a, b) => {\n                        const indexA = orderTopics.indexOf(a.abbreviation);\n                        const indexB = orderTopics.indexOf(b.abbreviation);\n\n                        return indexA - indexB;\n                    });\n\n                    this.dataToRender = objetoOrdenado;\n                }\n            },\n            fusionAlertAndNovelties() {\n                this.dataToRender = this.alerts;\n                this.dataToRender = this.dataToRender.concat(this.novelties);\n            },\n            cleanDataToRender() {\n                var newRenderBase = [];\n                // eslint-disable-next-line no-console\n                for (let i = 0; i < this.dataToRender.length; i++) {\n                    let element = this.dataToRender[i];\n                    var object = {};\n\n                    object.abbreviation = element.abbreviation;\n                    object.count = element.count || element.count_notices;\n                    object.description = this.getDescriptionString(element);\n                    object.icon = element.icon;\n                    object.id = element.id;\n                    object.permanent = element.is_permanent || false;\n                    object.langkey = element.lang_key;\n                    object.isNovelty = element.is_novelty || false;\n                    object.notices = element.notices || element.novelties;\n                    object.name = this.getGroupTitle(object,element);\n\n                    var arraynoticesmapped = [];\n\n                    for (let j = 0; j < object.notices.length; j++) {\n                        var elementnotices = object.notices[j];\n\n                        var noticesObj = {};\n                        noticesObj.id = elementnotices.id;\n                        noticesObj.title = this.getTitleString(elementnotices, element);\n                        noticesObj.detail = this.getDetailString(elementnotices, element);\n                        noticesObj.icon = this.getIcon(elementnotices, element);\n                        noticesObj.viewed = elementnotices.is_view;\n                        noticesObj.url = elementnotices.url || false;\n                        // NoticesObj.detailCounter = this.getDetailCounter(elementnotices,element);\n                        arraynoticesmapped.push(noticesObj);\n                    }\n\n                    object.notices = arraynoticesmapped;\n\n                    if (object.count > 0) {\n                        newRenderBase.push(object);\n                    }\n                }\n\n                this.dataToRender = newRenderBase;\n            },\n            getGroupTitle(object,elementParent){\n                if (object.isNovelty) {\n                    return elementParent.name;\n                }else{\n                    return this.langKeys[elementParent.lang_key];\n                }\n            },\n            getDetailCounter(element, elementParent) {\n                if (elementParent.is_novelty) {\n                    return false;\n                } else {\n                    return element.title.value;\n                }\n            },\n            getIcon(element, elementParent) {\n                if (elementParent.is_novelty) {\n                    return element.icon;\n                } else {\n                    // eslint-disable-next-line no-console\n                    return elementParent.icon;\n                }\n            },\n            getDescriptionString(element) {\n                if (element.description === 'lang.ac_son_close_desc') {\n                    return this.langKeys.about_to_close_block_description;\n                } else if (element.description === 'lang.overdue_activities_desc') {\n                    return this.langKeys.overdue_activity_block_description;\n                } else if (element.description === 'lang.ac_direct_message_desc') {\n                    return this.langKeys.not_read_message_block_description;\n                } else if (element.is_novelty) {\n                    return element.description;\n                } else {\n                    return '';\n                }\n            },\n            getTitleString(element, elementParent) {\n                if (elementParent.is_novelty) {\n                    return element.title;\n                } else {\n                    return element.detail;\n                }\n            },\n            getDetailString(element, elementParent) {\n                if (elementParent.is_novelty) {\n                    return `${element.message}`;\n                } else {\n                    return `${this.langKeys[element.title.lang_key]} ${element.title.value}`;\n                }\n            },\n            getIconImage(element) {\n                return M.util.image_url(element.icon.key, element.icon.component);\n            },\n            async markasview(element, elementParent) {\n                var error = false;\n                if (!elementParent.permanent) {\n                    if (elementParent.isNovelty) {\n                        let args = {\n                            novelty_id: element.id,\n                            type_novelty: elementParent.abbreviation\n                        };\n\n                        var request = await Repository.markedAsRead(args);\n                        if (!request.is_view) {\n                            error = true;\n                        }\n                    } else {\n                        var fetchUrl = `${this.alertsConfigs.urlapi}/notices/${element.id}/marked-viewed`;\n                        var request = await fetch(fetchUrl, {\n                            method: 'PUT'\n                        });\n\n                        if (request.status !== 204) {\n                            error = true;\n                        }\n                    }\n\n                    if (!error) {\n                        var indexParent = this.dataToRender.findIndex((x) => {\n                            return x.abbreviation === elementParent.abbreviation;\n                        });\n\n                        if (indexParent > -1) {\n                            var indexNotices = this.dataToRender[indexParent].notices.findIndex((x) => {\n                                return x.id === element.id;\n                            });\n\n                            this.dataToRender[indexParent].notices.splice(indexNotices, 1);\n\n                            // eslint-disable-next-line max-depth\n                            if (this.dataToRender[indexParent].notices.length === 0) {\n                                this.dataToRender.splice(indexParent, 1);\n                            }\n                        }\n                    }\n                }\n            }\n        },\n        mounted: async function () {\n            this.loading = true;\n            await this.getLangsKey();\n            await this.getNovelties();\n            await this.getAlertsConfigs();\n            await this.getAlerts();\n            await this.fusionAlertAndNovelties();\n            await this.cleanDataToRender();\n            this.orderTopics();\n            this.loading = false;\n        },\n        template: `\n        <v-app>\n            <v-main>\n                <div v-if=\"loading\">\n                    <v-card min-height=\"200\" elevation=\"0\" loading></v-card>\n                </div>\n                <div v-else>\n                    <div v-if=\"dataToRender.length == 0\">\n                        vista vacia\n                    </div>\n                    <div v-else>\n                        <v-tabs center-active show-arrows v-model=\"tab\" grow>\n                            <v-tab v-for=\"i in dataToRender\" :key=\"i.abbreviation\">\n                                <span class=\"text-capitalize\">{{i.name}}</span>\n                                <v-badge inline :content=\"i.notices.length\">\n                                </v-badge>\n                            </v-tab>\n                        </v-tabs>\n                        <v-divider class=\"ma-0\"></v-divider>\n                        <v-tabs-items v-model=\"tab\">\n                            <v-tab-item v-for=\"i in dataToRender\" :key=\"i.abbreviation\">\n                                <div class=\"pt-2\">\n                                    <div class=\"font-weight-bold\">\n                                        {{i.description}}\n                                    </div>\n                                    <div class=\"my-2 mx-1\" style=\"max-height: 190px; overflow-y: auto;\">\n                                        <v-hover v-slot=\"{ hover }\" v-for=\"j in i.notices\" :key=\"j.id\">\n                                            <v-card class=\"mb-1 mr-1 d-flex pa-2\" flat :color=\"hover ? '#f8f9fa' : ''\">\n                                                <div class=\"d-flex flex-grow-1\">\n                                                    <a :href=\"j.url ? j.url:'#'\" class=\"d-flex flex-grow-1\">\n                                                        <div class=\"d-flex align-center\">\n                                                            <div v-if=\"i.isNovelty\" class=\"activityiconcontainer \n                                                                assessment \n                                                                collaboration \n                                                                icon_novelties_alerts\n                                                                pa-1\n                                                                courseicon mr-3\" :class=\"j.purpose\">\n                                                                <v-img :src=\"getIconImage(j)\" class=\"activityicon\"></v-img>\n                                                            </div>\n                                                            <div class=\"activityiconcontainer\n                                                            assessment\n                                                            collaboration\n                                                            icon_novelties_alerts\n                                                            pa-1\n                                                            courseicon mr-3 activityicon\n                                                            \" v-else v-html=\"j.icon\">\n                                                            </div>\n                                                        </div>\n                                                        <div>\n                                                            <div v-html=\"j.title\" class=\"\n                                                                font-weight-bold\n                                                                primary--text\n                                                            \"></div>\n                                                            <div v-html=\"j.detail\" class=\"\n                                                                d-flex align-center \n                                                                font-weight-medium\n                                                                primary--text\n                                                                text-body-2\n                                                            \"></div>\n                                                        </div>\n                                                    </a>\n                                                </div>\n                                                <div v-if=\"!i.permanent\" class=\"d-flex align-center justify-center\"\n                                                    style=\"text-decoration: none\">\n                                                    <v-btn icon @click=\"markasview(j,i)\">\n                                                        <v-icon>\n                                                            mdi-eye\n                                                        </v-icon>\n                                                    </v-btn>\n                                                </div>\n                                            </v-card>\n                                        </v-hover>\n                                    </div>\n                                </div>\n                            </v-tab-item>\n                        </v-tabs-items>                    \n                    </div>\n                </div>\n            </v-main>\n        </v-app>\n        `\n    });\n};"],"names":["Vue","el","vuetify","Vuetify","data","loading","novelties","alertsConfigs","alerts","langKeys","dataToRender","tab","methods","langskeys","M","hasOwnProperty","plugins","courseView","langsKeys","response","Ajax","call","methodname","args","JSON","parse","lang","course_id","cfg","courseId","Repository","getNovelties","i","length","is_active","is_novelty","configskeys","configs","userid","contextInstanceId","params","URLSearchParams","set","this","user_id","institution","modality","fetchurl","urlapi","toString","fetch","catch","undefined","status","json","orderTopics","objetoOrdenado","sort","a","b","indexOf","abbreviation","fusionAlertAndNovelties","concat","cleanDataToRender","newRenderBase","element","object","count","count_notices","description","getDescriptionString","icon","id","permanent","is_permanent","langkey","lang_key","isNovelty","notices","name","getGroupTitle","arraynoticesmapped","j","elementnotices","noticesObj","title","getTitleString","detail","getDetailString","getIcon","viewed","is_view","url","push","elementParent","getDetailCounter","value","about_to_close_block_description","overdue_activity_block_description","not_read_message_block_description","message","getIconImage","util","image_url","key","component","error","novelty_id","type_novelty","markedAsRead","fetchUrl","method","indexParent","findIndex","x","indexNotices","splice","mounted","async","getLangsKey","getAlertsConfigs","getAlerts","template"],"mappings":"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"}